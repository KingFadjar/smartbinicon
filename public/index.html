<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Map App</title>
    <link rel="stylesheet" href="https://unpkg.com/mapbox-gl/dist/mapbox-gl.css">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body>
    <div id="map" style="width: 100%; height: 400px;"></div>
    <button id="updateLatLngButton">Update LatLng</button>
    <button id="loadDataButton">Load Data Locations</button>

    <script src="https://unpkg.com/mapbox-gl/dist/mapbox-gl.js"></script>
    <script src="https://unpkg.com/mapbox-gl-geocoder/dist/mapbox-gl-geocoder.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        document.getElementById('updateLatLngButton').addEventListener('click', async function () {
            try {
                const response = await fetch('http://localhost:3000/updateLatLng', { method: 'POST' });

                if (response.ok) {
                    const responseData = await response.json();
                    console.log(responseData.message);
                    // Reload peta atau lakukan tindakan lain yang diperlukan
                    loadMap();
                } else {
                    console.error('Failed to update LatLng:', response.statusText);
                }
            } catch (error) {
                console.error('Error updating LatLng:', error);
            }
        });

        document.getElementById('loadDataButton').addEventListener('click', function () {
            // Memanggil fungsi loadData saat tombol "Load Data Locations" ditekan
            loadData();
        });

        // Inisialisasi peta
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmFkamFyZGV2aWNvbiIsImEiOiJjbHM4ZGplcnYyNWU3MnJxcGlqYXFiZDg1In0.AtgLv67Wb3ap-HZyEYtpug';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [0, 0],
            zoom: 2
        });

        // Tambahkan sumber data GeoJSON
        map.on('load', function () {
            map.addSource('locations', {
                type: 'geojson',
                data: '/locations' // Menggunakan endpoint yang benar untuk mendapatkan data GeoJSON
            });

            // Tambahkan layer titik
            map.addLayer({
                id: 'locations',
                type: 'circle',
                source: 'locations',
                paint: {
                    'circle-radius': 6,
                    'circle-color': '#B42222' // Warna merah
                }
            });

            // Setelah peta dimuat, panggil fungsi loadData
            loadData();
        });

        // Fungsi untuk memuat data lokasi
async function loadData() {
    try {
        const response = await fetch('/locations');

        if (response.ok) {
            const locations = await response.json();
            console.log('Locations loaded successfully:', locations);

            // Pastikan locations.tbl_dir_bps2023 adalah array sebelum melakukan iterasi
            if (Array.isArray(locations.tbl_dir_bps2023)) {
                // Iterasi melalui lokasi untuk memeriksa nilai latlng yang null dan menggantinya jika ditemukan
                for (const location of locations.tbl_dir_bps2023) {
                    if (location.latlng === null) {
                        try {
                            const response = await axios.get('https://nominatim.openstreetmap.org/search', {
                                params: {
                                    q: location.alamat,
                                    format: 'json',
                                },
                            });

                            if (response.data.length > 0) {
                                const coordinates = [parseFloat(response.data[0].lon), parseFloat(response.data[0].lat)];
                                location.latlng = coordinates;
                            } else {
                                console.error(`Geocoding failed for ${location.alamat}`);
                            }
                        } catch (error) {
                            console.error(`Error during geocoding for ${location.alamat}:`, error.message);
                        }
                    }
                }

                // Membuat GeoJSON dengan properti "type" dan "features"
                const geoJSON = {
                    type: 'FeatureCollection',
                    features: locations.tbl_dir_bps2023.map(location => ({
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: location.latlng
                        },
                        properties: location
                    }))
                };

                map.getSource('locations').setData(geoJSON); // Perbarui data pada sumber
            } else {
                console.error('Invalid format: locations.tbl_dir_bps2023 is not an array');
            }
        } else {
            console.error('Failed to load locations:', response.statusText);
        }
    } catch (error) {
        console.error('Error loading locations:', error);
    }
}

    </script>
</body>

</html>
